<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MirSFlr ‚Äî Flare Validator & FTSO Provider</title>

  <meta name="description" content="MirSFlr ‚Äî Flare validator and FTSO provider. Transparent metrics, delegation guide, live embeds." />
  <meta name="theme-color" content="#0b1220" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="favicon-64x64.png">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070b14;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.52);

      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.10);
      --shadow:0 18px 60px rgba(0,0,0,.45);

      --r:18px; --r2:28px;
      --max:1120px;

      --brand:#7c5cff;
      --brand2:#23d5ff;
      --ok:#33d69f;

      /* === EMBED CROP (DESKTOP) ===
         Cilj: header + logo + Availability + Success Rate + zaƒçetek RE tabele
         NE: Price Feeds Last 6H
      */
      --embed-shift: 70px;     /* MANJ = embed gre bolj gor (bolj vidi≈° header/logo) */
      --embed-scale: 1.05;
      --embed-height: 420px;   /* MANJ = prej odre≈æe spodaj */

      /* Chart fixed height */
      --chart-h: 210px;
      --chart-h-mobile: 180px;
    }

    [data-theme="light"]{
      --bg:#f7f9ff;
      --text:rgba(10,14,25,.92);
      --muted:rgba(10,14,25,.72);
      --muted2:rgba(10,14,25,.56);
      --panel:rgba(10,14,25,.06);
      --panel2:rgba(10,14,25,.04);
      --border:rgba(10,14,25,.12);
      --shadow:0 18px 60px rgba(10,14,25,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(35,213,255,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 120%, rgba(51,214,159,.10), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:var(--max); margin:0 auto; padding:0 20px}

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--border);
      background: linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,.18));
    }
    [data-theme="light"] header{
      background: linear-gradient(to bottom, rgba(247,249,255,.86), rgba(247,249,255,.62));
    }
    .nav{height:74px; display:flex; align-items:center; justify-content:space-between; gap:16px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:-0.02em;}
    .logoImg{
      width:38px; height:38px; border-radius:14px;
      object-fit:contain;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 14px 26px rgba(124,92,255,.22);
      background: rgba(255,255,255,.06);
    }
    [data-theme="light"] .logoImg{border:1px solid rgba(10,14,25,.12);}
    .navlinks{display:flex; align-items:center; gap:12px; color:var(--muted); font-weight:700;}
    .navlinks a{padding:10px 10px; border-radius:12px}
    .navlinks a:hover{background:var(--panel2); color:var(--text)}
    .actions{display:flex; align-items:center; gap:10px}
    @media (max-width: 980px){ .navlinks{display:none} }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 14px; border-radius:14px;
      background:var(--panel2); border:1px solid var(--border);
      color:var(--text); font-weight:900; cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none; white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:var(--panel)}
    .btn.primary{
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      border-color:transparent;
      color:rgba(255,255,255,.95);
      box-shadow:0 18px 36px rgba(124,92,255,.18);
    }
    .btn.ghost{background:transparent}

    section{padding: 18px 0}
    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--border);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel{
      padding:16px;
      border-radius: var(--r2);
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
    }
    .titleRow{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
    .titleRow h2{margin:0; font-size:18px; letter-spacing:-0.02em}
    .tiny{font-size:12px; color:var(--muted2)}
    .muted{color:var(--muted)}

    .gridHero{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap:16px;
      align-items:stretch;
      margin-top: 18px;
    }
    @media (max-width: 980px){ .gridHero{grid-template-columns:1fr} }

    .hero{padding:22px; min-height: 380px; position:relative;}
    h1{margin: 14px 0 10px; font-size: clamp(30px, 3.2vw, 46px); letter-spacing:-0.035em; line-height:1.06;}
    .lead{margin:0 0 14px; color:var(--muted); line-height:1.65; max-width: 62ch; font-size: 16px;}
    .row{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}

    .side{padding:18px}
    .kpis{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:520px){ .kpis{grid-template-columns:1fr} }
    .kpi{padding:12px; border-radius: 16px; border:1px solid var(--border); background: rgba(255,255,255,.04); min-height: 68px;}
    .kpi .label{color:var(--muted2); font-size:12px; margin-bottom:6px}
    .kpi .value{font-weight:900; letter-spacing:-0.02em}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .addr{
      font-size:12px;
      color: rgba(255,255,255,.86);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      margin-top: 8px;
    }
    [data-theme="light"] .addr{
      color: rgba(10,14,25,.85);
      background: rgba(10,14,25,.04);
      border: 1px solid rgba(10,14,25,.12);
    }
    .divider{height:1px; background:var(--border); margin:12px 0}

    /* === PRICE CHART (X=price, Y=time) === */
    .chartWrap{
      border-radius: 18px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding:12px;
      overflow:hidden;
      position: relative;
    }
    canvas#flr24h{
      width:100%;
      height: var(--chart-h);
      display:block;
      touch-action: pan-y;
    }
    .chartLegend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      color: var(--muted2);
      font-size: 12px;
    }
    .chip{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-weight:900;
    }

    .tooltip{
      position:absolute;
      pointer-events:none;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.92);
      font-size: 12px;
      font-weight: 900;
      transform: translate(-50%, -110%);
      display:none;
      white-space: nowrap;
      z-index: 2;
    }
    [data-theme="light"] .tooltip{
      background: rgba(10,14,25,.72);
      border:1px solid rgba(10,14,25,.18);
    }

    /* === EMBED CROP (NO "Price Feeds Last 6H") === */
    .cropWrap{
      border-radius: 18px;
      border:1px solid var(--border);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      height: var(--embed-height);
      position: relative;
    }
    .cropWrap iframe{
      width: 100%;
      height: 1100px; /* velik "canvas", mi cropamo */
      border: 0;
      transform:
        translateY(calc(-1 * var(--embed-shift)))
        scale(var(--embed-scale));
      transform-origin: top center;
    }
    /* hard mask bottom */
    .cropWrap::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height: 160px; /* veƒç = bolj agresivno skrije spodaj */
      background: linear-gradient(to bottom, rgba(7,11,20,0), rgba(7,11,20,1));
      pointer-events:none;
    }
    [data-theme="light"] .cropWrap::after{
      background: linear-gradient(to bottom, rgba(247,249,255,0), rgba(247,249,255,1));
    }

    /* Layout helpers */
    .splitWide{display:grid; grid-template-columns: 1.35fr .65fr; gap:14px}
    @media (max-width: 980px){ .splitWide{grid-template-columns:1fr} }

    /* Mobile tweaks */
    @media (max-width: 980px){
      :root{
        --embed-shift: 95px;
        --embed-scale: 1.03;
        --embed-height: 520px;
        --chart-h: 190px;
      }
    }
    @media (max-width: 520px){
      :root{
        --embed-shift: 110px;
        --embed-scale: 1.02;
        --embed-height: 560px;
        --chart-h: var(--chart-h-mobile);
      }
      .btn{width:100%; justify-content:center}
      .hero{min-height:auto}
      .logoImg{width:36px;height:36px}
    }

    footer{padding: 26px 0 40px; color:var(--muted2)}
    .foot{
      display:flex; flex-wrap:wrap; gap:12px;
      align-items:center; justify-content:space-between;
      border-top:1px solid var(--border);
      padding-top:18px;
    }
    .links{display:flex; flex-wrap:wrap; gap:10px; color:var(--muted)}
    .links a{padding:8px 10px; border-radius:12px}
    .links a:hover{background: var(--panel2); color: var(--text)}

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: rgba(255,255,255,0.92);
      border:1px solid rgba(255,255,255,0.14);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
      font-weight:900;
      font-size: 13px;
      z-index: 60;
      max-width: calc(100vw - 32px);
      text-align:center;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px);}
    [data-theme="light"] .toast{background: rgba(10,14,25,0.82)}
  </style>
</head>

<body>
  <header>
    <div class="container">
      <div class="nav">
        <a class="brand" href="#top" aria-label="MirSFlr Home">
          <img src="logo.png" alt="MirSFlr logo" class="logoImg">
          <span>MirSFlr</span>
        </a>

        <nav class="navlinks" aria-label="Primary">
          <a href="#price">Price</a>
          <a href="#metrics">Metrics</a>
          <a href="#contact">Contact</a>
        </nav>

        <div class="actions">
          <button class="btn ghost" id="themeBtn" type="button" aria-label="Toggle theme">
            üåó <span class="tiny" id="themeLabel">Theme</span>
          </button>
          <a class="btn primary" href="#metrics">üìà Metrics</a>
        </div>
      </div>
    </div>
  </header>

  <main id="top" class="container">

    <!-- HERO -->
    <section>
      <div class="gridHero">
        <div class="card hero">
          <h1>Validator + FTSO Provider (MirSFlr)</h1>
          <p class="lead">
            Transparent metrics + clear identity + simple delegation guidance.
          </p>

          <div class="row">
            <a class="btn" href="https://x.com/mirsFlR_" target="_blank" rel="noopener">ùïè @mirsFlR_</a>
            <a class="btn" href="https://t.me/Mirhollio" target="_blank" rel="noopener">‚úàÔ∏è @Mirhollio</a>
            <a class="btn" href="mailto:mirsven@icloud.com">‚úâÔ∏è mirsven@icloud.com</a>
            <button class="btn" type="button" id="copyAllBtn">üìã Copy key addresses</button>
          </div>
        </div>

        <!-- QUICK SNAPSHOT -->
        <aside class="card side" aria-label="Quick snapshot">
          <div class="titleRow">
            <h2>Quick Snapshot</h2>
            <a class="btn" href="https://flare-systems-explorer.flare.network/providers/ftso/0xb5A081dEc72c8C87256b7e14cFAdcbc342bDeac3"
               target="_blank" rel="noopener" style="padding:8px 10px;">
              ‚Üó Explorer
            </a>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">Role</div>
              <div class="value">Validator</div>
            </div>
            <div class="kpi">
              <div class="label">Also</div>
              <div class="value">FTSO Provider</div>
            </div>
            <div class="kpi">
              <div class="label">Monitoring</div>
              <div class="value">24/7 Alerts</div>
            </div>
            <div class="kpi">
              <div class="label">Focus</div>
              <div class="value">Stability</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="tiny">Delegation address</div>
            <div class="addr mono" id="delegateAddr"></div>

            <div class="divider"></div>

            <div class="tiny">FTSO provider (identity)</div>
            <div class="addr mono" id="ftsoAddr"></div>

            <div class="divider"></div>
            <div class="tiny">Tip: verify identity on trusted sources before delegating.</div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn" id="copyDelegateBtn" type="button">üìã Copy delegation</button>
            <button class="btn" id="copyFtsoBtn" type="button">üìã Copy identity</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- PRICE -->
    <section id="price">
      <div class="panel">
        <div class="titleRow">
          <h2>FLR Price</h2>
          <span class="tiny" id="priceStatus">Loading‚Ä¶</span>
        </div>

        <div class="splitWide">
          <div>
            <div class="chartWrap" id="chartWrap">
              <div class="tooltip" id="tooltip"></div>
              <canvas id="flr24h"></canvas>

              <div class="chartLegend">
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <span class="chip" id="usdChip">USD: ‚Äî</span>
                  <span class="chip" id="eurChip">EUR: ‚Äî</span>
                </div>
                <div class="tiny" id="chartStatus">Loading‚Ä¶</div>
              </div>
              <div class="tiny" style="margin-top:8px">
                Graf je rotiran po tvoji ≈æelji: <b>X = cena</b>, <b>Y = ƒças</b>. Hover/touch poka≈æe toƒçno vrednost.
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="priceRefresh" type="button">‚ü≥ Refresh</button>
              <a class="btn" href="https://www.coingecko.com/en/coins/flare" target="_blank" rel="noopener">‚Üó CoinGecko</a>
            </div>
          </div>

          <div class="card" style="padding:16px; box-shadow:none">
            <h2 style="margin:0 0 10px">Market snapshot</h2>
            <div class="kpis">
              <div class="kpi">
                <div class="label">FLR Spot (USD)</div>
                <div class="value" id="spotUsd">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="label">FLR Spot (EUR)</div>
                <div class="value" id="spotEur">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="label">Last updated</div>
                <div class="value" id="spotTime">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="label">Chart source</div>
                <div class="value" id="chartMode">‚Äî</div>
              </div>
            </div>

            <div class="tiny" style="margin-top:10px">
              CoinGecko je ‚Äúbest effort‚Äù (lahko blokira). ƒåe faila, graf avtomatsko preklopi na Coinbase candles.
              Brez broken widget box-ov.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- METRICS -->
    <section id="metrics">
      <div class="panel">
        <div class="titleRow">
          <h2>FTSO Provider metrics (cropped)</h2>
          <div class="tiny">Brez ‚ÄúPrice Feeds Last 6H‚Äù sekcije.</div>
        </div>

        <div class="cropWrap">
          <iframe
            title="Flare Systems Explorer ‚Äî FTSO Provider"
            loading="lazy"
            referrerpolicy="no-referrer"
            src="https://flare-systems-explorer.flare.network/providers/ftso/0xb5A081dEc72c8C87256b7e14cFAdcbc342bDeac3">
          </iframe>
        </div>

        <div class="row" style="margin-top:12px">
          <a class="btn primary" href="https://flare-systems-explorer.flare.network/providers/ftso/0xb5A081dEc72c8C87256b7e14cFAdcbc342bDeac3" target="_blank" rel="noopener">
            ‚Üó Open full page
          </a>
        </div>

        <div class="tiny" style="margin-top:10px">
          ƒåe se ti ≈°e kdaj poka≈æe 6H del: zni≈æaj <span class="mono">--embed-height</span> ali poveƒçaj mask height v <span class="mono">.cropWrap::after</span>.
        </div>
      </div>
    </section>

    <!-- CONTACT -->
    <section id="contact">
      <div class="panel">
        <div class="titleRow">
          <h2>Contact</h2>
          <span class="tiny">mirsven@icloud.com</span>
        </div>
        <div class="row" style="margin-top:0">
          <a class="btn primary" href="mailto:mirsven@icloud.com">‚úâÔ∏è Email</a>
          <a class="btn" href="https://x.com/mirsFlR_" target="_blank" rel="noopener">ùïè X</a>
          <a class="btn" href="https://t.me/Mirhollio" target="_blank" rel="noopener">‚úàÔ∏è Telegram</a>
          <button class="btn" id="copyEmailBtn" type="button">üìé Copy email</button>
        </div>
      </div>
    </section>

    <footer>
      <div class="foot">
        <div>
          <div style="font-weight:900; color:var(--text); letter-spacing:-0.02em">MirSFlr</div>
          <div class="tiny">¬© <span id="year"></span> ‚Äî GitHub Pages</div>
        </div>
        <div class="links">
          <a href="https://flaremetrics.io/" target="_blank" rel="noopener">flaremetrics.io</a>
          <a href="https://flare.network/" target="_blank" rel="noopener">flare.network</a>
        </div>
      </div>
    </footer>

  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    const CONFIG = {
      delegationAddress: "0xAd9105BEF5E5df2Eacbe2De9037A96695b00cade",
      ftsoProviderIdentity: "0xb5A081dEc72c8C87256b7e14cFAdcbc342bDeac3",
      contactEmail: "mirsven@icloud.com"
    };

    // Theme
    const root = document.documentElement;
    const themeBtn = document.getElementById("themeBtn");
    const themeLabel = document.getElementById("themeLabel");
    function setTheme(theme){
      root.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      if (themeLabel) themeLabel.textContent = theme === "light" ? "Light" : "Dark";
    }
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "light" || savedTheme === "dark") setTheme(savedTheme);
    if (themeBtn) themeBtn.addEventListener("click", () => {
      const cur = root.getAttribute("data-theme") || "dark";
      setTheme(cur === "dark" ? "light" : "dark");
    });

    // Toast
    const toast = document.getElementById("toast");
    let toastT;
    function showToast(msg){
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastT);
      toastT = setTimeout(() => toast.classList.remove("show"), 1500);
    }

    // Clipboard
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        showToast("Copied ‚úÖ");
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast("Copied ‚úÖ");
      }
    }

    // Fill addresses
    const delegateAddr = document.getElementById("delegateAddr");
    const ftsoAddr = document.getElementById("ftsoAddr");
    if (delegateAddr) delegateAddr.textContent = CONFIG.delegationAddress;
    if (ftsoAddr) ftsoAddr.textContent = CONFIG.ftsoProviderIdentity;

    // Buttons
    const copyDelegateBtn = document.getElementById("copyDelegateBtn");
    const copyFtsoBtn = document.getElementById("copyFtsoBtn");
    const copyAllBtn = document.getElementById("copyAllBtn");
    const copyEmailBtn = document.getElementById("copyEmailBtn");

    if (copyDelegateBtn) copyDelegateBtn.addEventListener("click", () => copyText(CONFIG.delegationAddress));
    if (copyFtsoBtn) copyFtsoBtn.addEventListener("click", () => copyText(CONFIG.ftsoProviderIdentity));
    if (copyEmailBtn) copyEmailBtn.addEventListener("click", () => copyText(CONFIG.contactEmail));

    if (copyAllBtn) copyAllBtn.addEventListener("click", () => {
      const block = [
        "MirSFlr ‚Äî verification",
        "",
        "Delegation address:",
        CONFIG.delegationAddress,
        "",
        "FTSO provider identity:",
        CONFIG.ftsoProviderIdentity,
        "",
        "X: https://x.com/mirsFlR_",
        "Telegram: https://t.me/Mirhollio",
        "Email: " + CONFIG.contactEmail
      ].join("\n");
      copyText(block);
    });

    // Footer year
    const year = document.getElementById("year");
    if (year) year.textContent = new Date().getFullYear();

    // ===== PRICE + CHART =====
    const priceStatus = document.getElementById("priceStatus");
    const spotUsd = document.getElementById("spotUsd");
    const spotEur = document.getElementById("spotEur");
    const spotTime = document.getElementById("spotTime");
    const chartMode = document.getElementById("chartMode");
    const priceRefresh = document.getElementById("priceRefresh");

    const usdChip = document.getElementById("usdChip");
    const eurChip = document.getElementById("eurChip");
    const chartStatus = document.getElementById("chartStatus");

    const canvas = document.getElementById("flr24h");
    const ctx = canvas?.getContext("2d");
    const tooltip = document.getElementById("tooltip");
    const chartWrap = document.getElementById("chartWrap");

    let seriesUSD = null; // [[ts, price], ...]
    let seriesEUR = null;
    let drawCache = null;

    function setChartStatus(t){ if (chartStatus) chartStatus.textContent = t; }

    function fmtTime(ts){
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    function resizeCanvas(){
      if (!canvas || !ctx) return null;
      const w = canvas.clientWidth;
      const h = parseInt(getComputedStyle(canvas).height, 10) || 210;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {w,h};
    }

    // Rotiran graf: X = price, Y = time
    function drawRotated(series){
      if (!canvas || !ctx || !series || series.length < 2) return;
      const sz = resizeCanvas();
      if (!sz) return;
      const {w,h} = sz;

      ctx.clearRect(0,0,w,h);

      const padL = 44;  // left: time labels
      const padR = 14;
      const padT = 14;
      const padB = 32;  // bottom: price labels

      // time range
      const xs = series.map(p=>p[1]); // price -> X axis
      const ys = series.map(p=>p[0]); // time  -> Y axis

      const minP = Math.min(...xs), maxP = Math.max(...xs);
      const minT = Math.min(...ys), maxT = Math.max(...ys);

      const toX = (p) => padL + (w - padL - padR) * ((p - minP) / ((maxP - minP)||1));
      // time grows downward (older top, newer bottom)
      const toY = (t) => padT + (h - padT - padB) * ((t - minT) / ((maxT - minT)||1));

      drawCache = {w,h,padL,padR,padT,padB,minP,maxP,minT,maxT,toX,toY};

      // grid
      ctx.globalAlpha = 0.18;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--border").trim() || "rgba(255,255,255,.12)";
      ctx.lineWidth = 1;

      // horizontal (time) grid lines
      for (let i=1;i<=3;i++){
        const gy = padT + (h - padT - padB) * (i/4);
        ctx.beginPath(); ctx.moveTo(padL, gy); ctx.lineTo(w-padR, gy); ctx.stroke();
      }
      // vertical (price) grid lines
      for (let i=1;i<=3;i++){
        const gx = padL + (w - padL - padR) * (i/4);
        ctx.beginPath(); ctx.moveTo(gx, padT); ctx.lineTo(gx, h-padB); ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // line + fill
      const grad = ctx.createLinearGradient(padL, 0, w-padR, 0);
      grad.addColorStop(0, "rgba(124,92,255,0.20)");
      grad.addColorStop(1, "rgba(35,213,255,0.08)");

      ctx.beginPath();
      ctx.moveTo(toX(xs[0]), toY(ys[0]));
      for (let i=1;i<series.length;i++){
        ctx.lineTo(toX(xs[i]), toY(ys[i]));
      }
      ctx.lineWidth = 2.2;
      ctx.strokeStyle = "rgba(124,92,255,0.95)";
      ctx.stroke();

      // fill to baseline (min price)
      ctx.lineTo(toX(minP), toY(ys[ys.length-1]));
      ctx.lineTo(toX(minP), toY(ys[0]));
      ctx.closePath();
      ctx.fillStyle = grad;
      ctx.fill();

      // left labels (time)
      ctx.globalAlpha = 0.78;
      ctx.fillStyle = "rgba(255,255,255,.72)";
      ctx.font = "700 11px Inter, system-ui, sans-serif";
      for (let i=0;i<=4;i++){
        const t = minT + (maxT-minT)*(i/4);
        const y = toY(t);
        ctx.fillText(fmtTime(t), 8, y+4);
      }

      // bottom labels (price)
      const ticks = 4;
      for (let i=0;i<=ticks;i++){
        const p = minP + (maxP-minP)*(i/ticks);
        const x = toX(p);
        const label = "$" + p.toFixed(4);
        ctx.fillText(label, Math.max(padL, x-16), h-10);
      }
      ctx.globalAlpha = 1;

      // chips
      const lastUsd = series[series.length-1][1];
      if (usdChip) usdChip.textContent = "USD: $" + Number(lastUsd).toFixed(6);

      if (seriesEUR && seriesEUR.length){
        const eurLast = seriesEUR[seriesEUR.length-1][1];
        if (eurChip) eurChip.textContent = "EUR: ‚Ç¨" + Number(eurLast).toFixed(6);
      } else {
        if (eurChip) eurChip.textContent = "EUR: ‚Äî";
      }
    }

    function showTooltip(clientX, clientY){
      if (!drawCache || !seriesUSD) return;
      const rect = canvas.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;

      // find nearest by Y (time)
      const {padT,padB,h,minT,maxT} = drawCache;
      const yClamped = Math.max(padT, Math.min(h-padB, y));
      const ratio = (yClamped - padT) / ((h - padT - padB) || 1);
      const tApprox = minT + (maxT-minT)*ratio;

      // nearest index by time
      let bestI = 0;
      let bestD = Infinity;
      for (let i=0;i<seriesUSD.length;i++){
        const d = Math.abs(seriesUSD[i][0] - tApprox);
        if (d < bestD){ bestD = d; bestI = i; }
      }

      const ts = seriesUSD[bestI][0];
      const usd = seriesUSD[bestI][1];
      const eur = (seriesEUR && seriesEUR[bestI]) ? seriesEUR[bestI][1] : null;

      // redraw + hover marker (crosshair)
      drawRotated(seriesUSD);

      const {toX,toY} = drawCache;
      const px = toX(usd);
      const py = toY(ts);

      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = "rgba(255,255,255,.55)";
      ctx.lineWidth = 1;

      ctx.beginPath(); ctx.moveTo(px, drawCache.padT); ctx.lineTo(px, drawCache.h-drawCache.padB); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(drawCache.padL, py); ctx.lineTo(drawCache.w-drawCache.padR, py); ctx.stroke();
      ctx.globalAlpha = 1;

      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.beginPath(); ctx.arc(px, py, 3.5, 0, Math.PI*2); ctx.fill();

      if (tooltip && chartWrap){
        tooltip.style.display = "block";
        const wrapRect = chartWrap.getBoundingClientRect();
        tooltip.style.left = (clientX - wrapRect.left) + "px";
        tooltip.style.top = (py + 10) + "px";
        tooltip.textContent = `${fmtTime(ts)} ‚Ä¢ $${usd.toFixed(6)}${eur!=null ? " ‚Ä¢ ‚Ç¨"+eur.toFixed(6) : ""}`;
      }
    }

    function hideTooltip(){
      if (tooltip) tooltip.style.display = "none";
      if (seriesUSD) drawRotated(seriesUSD);
    }

    function attachHover(){
      if (!canvas) return;
      canvas.addEventListener("mousemove", (e)=> showTooltip(e.clientX, e.clientY));
      canvas.addEventListener("mouseleave", hideTooltip);

      canvas.addEventListener("touchstart", (e)=>{
        const t = e.touches?.[0]; if (!t) return;
        showTooltip(t.clientX, t.clientY);
      }, {passive:true});

      canvas.addEventListener("touchmove", (e)=>{
        const t = e.touches?.[0]; if (!t) return;
        showTooltip(t.clientX, t.clientY);
      }, {passive:true});

      canvas.addEventListener("touchend", hideTooltip, {passive:true});
    }

    async function loadSpot(){
      if (priceStatus) priceStatus.textContent = "Loading‚Ä¶";
      try{
        const resUSD = await fetch("https://api.coinbase.com/v2/prices/FLR-USD/spot", { mode:"cors" });
        if (!resUSD.ok) throw new Error("spot usd fail");
        const jUSD = await resUSD.json();
        const amtUSD = Number(jUSD?.data?.amount);
        if (!isFinite(amtUSD)) throw new Error("bad usd");

        let amtEUR = null;
        try{
          const resEUR = await fetch("https://api.coinbase.com/v2/prices/FLR-EUR/spot", { mode:"cors" });
          if (resEUR.ok){
            const jEUR = await resEUR.json();
            const v = Number(jEUR?.data?.amount);
            if (isFinite(v)) amtEUR = v;
          }
        }catch(_){}

        if (spotUsd) spotUsd.textContent = "$" + amtUSD.toFixed(6);
        if (spotEur) spotEur.textContent = (amtEUR!=null) ? ("‚Ç¨" + amtEUR.toFixed(6)) : "‚Ç¨ ‚Äî";
        if (spotTime) spotTime.textContent = new Date().toLocaleString();
        if (priceStatus) priceStatus.textContent = "Updated";
      }catch(e){
        if (priceStatus) priceStatus.textContent = "Spot failed (Coinbase)";
      }
    }

    // === Chart data sources ===
    async function fetchCoinGecko24h(vs){
      // Best effort only (often blocked). If blocked, we silently fallback.
      const url = `https://api.coingecko.com/api/v3/coins/flare/market_chart?vs_currency=${vs}&days=1&interval=hourly`;
      const res = await fetch(url, { mode:"cors" });
      if (!res.ok) throw new Error("CG blocked");
      const j = await res.json();
      if (!j?.prices?.length) throw new Error("CG no data");
      return j.prices; // [[ts, price], ...]
    }

    async function fetchCoinbaseCandles24h(){
      const end = new Date();
      const start = new Date(end.getTime() - 24*60*60*1000);
      const url = `https://api.exchange.coinbase.com/products/FLR-USD/candles?granularity=3600&start=${start.toISOString()}&end=${end.toISOString()}`;
      const res = await fetch(url, { mode:"cors" });
      if (!res.ok) throw new Error("CB candles blocked");
      const arr = await res.json();
      if (!Array.isArray(arr) || arr.length < 2) throw new Error("CB candles no data");
      const sorted = arr.slice().sort((a,b)=>a[0]-b[0]);
      // [time, low, high, open, close, volume] -> use close
      return sorted.map(c => [c[0]*1000, c[4]]);
    }

    async function loadChart(){
      setChartStatus("Loading chart‚Ä¶");

      // 1) Try CoinGecko quietly (no widget, no errors)
      try{
        const [usd, eur] = await Promise.all([
          fetchCoinGecko24h("usd"),
          fetchCoinGecko24h("eur")
        ]);
        seriesUSD = usd;
        seriesEUR = eur;
        drawRotated(seriesUSD);
        setChartStatus("Hover/touch for exact value.");
        if (chartMode) chartMode.textContent = "CoinGecko 24h";
        return;
      }catch(_){ /* silent */ }

      // 2) Fallback: Coinbase candles for USD, EUR from FX (EURUSD) approximated
      try{
        const usd = await fetchCoinbaseCandles24h();
        seriesUSD = usd;

        // EUR approximate using EUR-USD FX spot
        let eurPerUsd = null;
        try{
          const fxRes = await fetch("https://api.coinbase.com/v2/prices/EUR-USD/spot", { mode:"cors" });
          if (fxRes.ok){
            const j = await fxRes.json();
            const eurUsd = Number(j?.data?.amount); // USD per 1 EUR
            if (isFinite(eurUsd) && eurUsd > 0) eurPerUsd = 1 / eurUsd;
          }
        }catch(_){}

        if (eurPerUsd){
          seriesEUR = usd.map(([ts,p]) => [ts, p * eurPerUsd]);
        } else {
          seriesEUR = null;
        }

        drawRotated(seriesUSD);
        setChartStatus("Hover/touch for exact value.");
        if (chartMode) chartMode.textContent = "Coinbase candles 24h";
        return;
      }catch(e){
        // last resort: show empty but no ‚Äúbroken widget‚Äù
        seriesUSD = null;
        seriesEUR = null;
        setChartStatus("Chart unavailable (blocked).");
        if (chartMode) chartMode.textContent = "Unavailable";
      }
    }

    async function refreshAll(){
      await loadSpot();
      await loadChart();
    }

    if (priceRefresh) priceRefresh.addEventListener("click", refreshAll);

    // init
    attachHover();
    refreshAll();

    window.addEventListener("resize", () => {
      if (seriesUSD) drawRotated(seriesUSD);
    });

    // Copy email
    if (copyEmailBtn) copyEmailBtn.addEventListener("click", () => copyText(CONFIG.contactEmail));
  </script>
</body>
</html>
