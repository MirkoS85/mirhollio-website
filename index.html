<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MirSFlr - Flare Network Dashboard</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; color:#333; margin:0; padding:20px; }
.container { max-width:1200px; margin:0 auto; }
h1 { text-align:center; color:#1a73e8; }
.section { background:white; margin:20px 0; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-wrap:wrap; justify-content:space-between; align-items:flex-start; }
.metric-left { width:48%; }
.metric-right { width:48%; text-align:center; }
.counter { font-size:2em; font-weight:bold; color:#1a73e8; text-align:center; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:8px; text-align:left; border-bottom:1px solid #ddd; font-size:0.85em; }
th { background-color:#f8f9fa; }
.loading { text-align:center; color:#666; }
.error { color:#d93025; text-align:center; }
.no-data { text-align:center; color:#999; font-style:italic; }
details { margin-top:10px; width:100%; }
summary { cursor:pointer; font-weight:bold; color:#1a73e8; }
.activity-text { font-size:0.9em; color:#666; margin-bottom:10px; width:100%; }
canvas { max-width:100%; height:250px; display:block; }
.hidden { display:none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="container">
<h1>ðŸ”¥ MirSFlr - Flare Network Live Podatki</h1>

<!-- Token price -->
<div class="section">
  <div class="metric-left">
    <h2>FLR Token Price (EUR)</h2>
    <div id="flr-price" class="counter loading">Nalagam...</div>
  </div>
</div>

<!-- Transactions -->
<div class="section">
  <div class="metric-left">
    <h2>Transakcije (24h)</h2>
    <div id="tx-counter" class="counter loading">Nalagam...</div>
    <details id="tx-details">
      <summary>RazÅ¡iri zadnjih 100 transakcij</summary>
      <table id="tx-table">
        <thead><tr><th>Hash</th><th>Od</th><th>Do</th><th>Vrednost (FLR)</th></tr></thead>
        <tbody></tbody>
      </table>
    </details>
  </div>
</div>

<!-- Validators -->
<div class="section">
  <div class="metric-left">
    <h2>Aktivni Validatorji</h2>
    <div id="validators-counter" class="counter loading">Nalagam...</div>
    <table id="validators-table">
      <thead><tr><th>Node ID</th><th>Stake (FLR)</th><th>Delegated (FLR)</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="metric-right">
    <canvas id="validators-chart"></canvas>
  </div>
</div>

<!-- Stake & Delegations -->
<div class="section">
  <div class="metric-left">
    <h2>Stake & Delegations</h2>
    <div id="stake-info" class="loading">Nalagam...</div>
  </div>
  <div class="metric-right">
    <canvas id="stake-chart"></canvas>
  </div>
</div>

<!-- Network Activity -->
<div class="section">
  <div class="metric-left">
    <h2>Network Activity (zadnjih 10 dni)</h2>
    <div class="activity-text">Å tevilo blokov in transakcij/dan (zadnjih 10 dni)</div>
    <div id="activity-info" class="loading">Nalagam...</div>
  </div>
  <div class="metric-right">
    <canvas id="activity-chart"></canvas>
  </div>
</div>
</div>

<script>
const BLOCKSCOUT = 'https://flare-explorer.flare.network/api/v2';
const FLARE_RPC = 'https://flare-api.flare.network/ext/bc/P';
const ATTO = 1e18;
let validatorsChart, stakeChart, activityChart;

// --- Token price via proxy ---
async function fetchPrice(){
  try{
    const proxy='https://api.allorigins.win/raw?url=';
    const url=encodeURIComponent('https://api.coingecko.com/api/v3/simple/price?ids=flare&vs_currencies=eur');
    const data=await (await fetch(proxy+url)).json();
    return (data.flare?.eur||0).toFixed(4);
  }catch(e){console.error(e); return null;}
}

// --- REST fetch ---
async function fetchRest(endpoint){
  try{ const r=await fetch(`${BLOCKSCOUT}${endpoint}`); return r.ok? await r.json() : {error:`HTTP ${r.status}`}; }
  catch(e){console.error(e); return {error:e.message}; }
}

// --- RPC fetch ---
async function fetchRpc(method){
  try{
    const r=await fetch(FLARE_RPC,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method,params:[]})});
    const data=await r.json();
    if(data.error) throw new Error(data.error?.message||'RPC error');
    return data.result;
  }catch(e){console.error(e); return {error:e.message}; }
}

// --- Dashboard update ---
async function updateDashboard(){
  // Price
  const priceDiv=document.getElementById('flr-price');
  const price=await fetchPrice();
  priceDiv.innerHTML=price? `<span>${price} â‚¬</span>`:`<span class="no-data">Ni podatkov</span>`;
  priceDiv.classList.remove('loading');

  // Transactions
  const stats=await fetchRest('/stats');
  const txData=await fetchRest('/transactions?limit=100');
  const txTable=document.querySelector('#tx-table tbody');
  const txCounter=document.getElementById('tx-counter');
  const txDetails=document.getElementById('tx-details');
  if(stats.error || txData.error || !txData.items){
    txCounter.innerHTML='<span class="error">Ni podatkov</span>';
    txDetails.classList.add('hidden');
  } else {
    const tx24h=stats.transactions_today||0;
    txCounter.innerHTML=`<span>${tx24h.toLocaleString()}</span> (24h)`;
    txCounter.classList.remove('loading');
    txTable.innerHTML=txData.items.slice(0,100).map(tx=>`<tr>
      <td>${(tx.hash||'').slice(0,10)}...</td>
      <td>${(tx.from?.hash||tx.from||'').slice(0,10)}...</td>
      <td>${(tx.to?.hash||tx.to||'Contract').slice(0,10)}</td>
      <td>${tx.value? (Number(tx.value)/ATTO).toFixed(4)+' FLR':'0'}</td>
    </tr>`).join('');
    txDetails.classList.remove('hidden');
  }

  // Validators
  const valData=await fetchRpc('platform.getCurrentValidators');
  const valTable=document.querySelector('#validators-table tbody');
  const valCounter=document.getElementById('validators-counter');
  const valCtx=document.getElementById('validators-chart').getContext('2d');
  if(valData.error || !valData.validators){
    valCounter.innerHTML='<span class="error">Ni podatkov</span>';
    valTable.innerHTML='<tr><td colspan="4" class="no-data">Ni validatorjev</td></tr>';
    if(validatorsChart) validatorsChart.destroy();
  } else {
    const vals=valData.validators;
    valCounter.innerHTML=`<span>${vals.length}</span> aktivnih`;
    valCounter.classList.remove('loading');
    valTable.innerHTML=vals.slice(0,5).map(v=>`<tr>
      <td>${v.nodeID.slice(0,10)}...</td>
      <td>${v.stakeAmount? (Number(v.stakeAmount)/ATTO).toFixed(4):'0'}</td>
      <td>${v.delegatedAmount? (Number(v.delegatedAmount)/ATTO).toFixed(4):'0'}</td>
      <td>Aktiven</td>
    </tr>`).join('');
    const sorted=vals.sort((a,b)=>Number(b.stakeAmount||0)-Number(a.stakeAmount||0)).slice(0,5);
    if(validatorsChart) validatorsChart.destroy();
    validatorsChart=new Chart(valCtx,{type:'bar',data:{labels:sorted.map(v=>v.nodeID.slice(0,6)+'...'),datasets:[{label:'Stake (FLR)',data:sorted.map(v=>Number(v.stakeAmount||0)/ATTO),backgroundColor:'#1a73e8'}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
  }

  // Stake & Delegations
  const totalStake=await fetchRpc('platform.getTotalStake');
  const stakeDiv=document.getElementById('stake-info');
  const stakeCtx=document.getElementById('stake-chart').getContext('2d');
  let totalDeleg=valData.validators? valData.validators.reduce((sum,v)=>sum+(v.delegatedAmount?Number(v.delegatedAmount)/ATTO:0),0):0;
  if(totalStake.error){
    stakeDiv.innerHTML='<p class="no-data">Ni podatkov (stake:0, delegations:0)</p>';
    if(stakeChart) stakeChart.destroy();
  } else {
    const tStake=Number(totalStake.stakeAmount||0)/ATTO;
    stakeDiv.innerHTML=`<p>Total Stake: ${tStake.toFixed(4)} FLR</p><p>Total Delegations: ${totalDeleg.toFixed(4)} FLR</p>`;
    stakeDiv.classList.remove('loading');
    if(stakeChart) stakeChart.destroy();
    stakeChart=new Chart(stakeCtx,{type:'pie',data:{labels:['Total Stake','Total Delegations'],datasets:[{data:[tStake,totalDeleg],backgroundColor:['#1a73e8','#0f9d58']}]},options:{responsive:true}});
  }

  // Network activity
  const blocks=await fetchRest('/blocks?limit=5000');
  const actDiv=document.getElementById('activity-info');
  const actCtx=document.getElementById('activity-chart').getContext('2d');
  if(blocks.error || !blocks.items){
    actDiv.innerHTML='<p class="no-data">Ni podatkov</p>';
    if(activityChart) activityChart.destroy();
  } else {
    const tenDays=new Date(Date.now()-10*24*60*60*1000);
    const recent=blocks.items.filter(b=>new Date(b.timestamp)>tenDays);
    const daily={};
    recent.forEach(b=>{
      const d=new Date(b.timestamp).toLocaleDateString('sl-SI');
      daily[d]=daily[d]?{blocks:daily[d].blocks+1,tx:(daily[d].tx||0)+(b.transactions?.length||0)}:{blocks:1,tx:b.transactions?.length||0};
    });
    actDiv.innerHTML=Object.entries(daily).sort((a,b)=>new Date(b[0])-new Date(a[0])).map(([d,v])=>`<p>${d}: ${v.blocks} blokov, ${v.tx} TX</p>`).join('')||'<p class="no-data">Ni aktivnosti</p>';
    actDiv.classList.remove('loading');
    const days=Object.keys(daily).sort().slice(-10);
    if(activityChart) activityChart.destroy();
    activityChart=new Chart(actCtx,{type:'line',data:{labels:days,datasets:[{label:'Bloki/dan',data:days.map(d=>daily[d].blocks),borderColor:'#1a73e8',fill:false}]},options:{responsive:true}});
  }
}

// --- Initial load + refresh ---
updateDashboard();
setInterval(updateDashboard,30000);
</script>
</body>
</html>
